# 如何确保消息不丢

一条消息从生产到消费完成这个过程，可以划分三个阶段

![image-20220210151511483](/Users/chengjin/my-github/blog/jimDevil.github.io/images/image-20220210151511483.png)

+ 生产阶段: 在这个阶段，从消息在 Producer 创建出来，经过网络传输发送到 Broker端。
+ 存储阶段: 在这个阶段，消息在 Broker 端存储，如果是集群，消息会在这个阶段被复制到其他的副本上。
+ 消费阶段: 在这个阶段，Consumer 从 Broker 上拉取消息，经过网络传输发送到Consumer 上。

##### 确保消息不丢失

+ 在生产阶段，你需要捕获消息发送的错误，并重发消息。
+ 在存储阶段，你可以通过配置刷盘和复制相关的参数，让消息写入到多个副本的磁盘上，来确保消息不会因为某个 Broker 宕机或者磁盘损坏而丢失。
+ 在消费阶段，你需要在处理完全部消费业务逻辑之后，再发送消费确认。

